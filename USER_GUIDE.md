# Elahe Tunnel User Guide

Elahe Tunnel is an advanced, secure, and censorship-resistant tunneling tool designed to bypass network restrictions by masquerading your traffic as normal web traffic. It provides TCP, UDP, and DNS tunneling capabilities, ensuring your data remains private and accessible even in highly restricted environments.

## Features

- **Traffic Masquerading**: Hides your traffic by wrapping it in HTTP/WebSocket requests that mimic Google searches and standard web traffic.
- **Multiplexing (Mux)**: Uses a single persistent connection to handle multiple streams, significantly improving stability and reducing latency (similar to tools like Chisel and frp).
- **Strong Encryption**: Uses AES-GCM encryption to secure all data passing through the tunnel.
- **TCP & UDP Support**: Tunnels both TCP and UDP traffic. UDP traffic is secured using DTLS (Datagram Transport Layer Security).
- **DNS Proxy**: Proxies DNS queries securely over the tunnel to prevent DNS hijacking and spoofing.
- **Web Panel**: Includes a built-in web panel to monitor connection health, traffic statistics, and data transfer rates in real-time.
- **Client/Server Architecture**: Operates with an "Internal" node (Client) and an "External" node (Server) for seamless connectivity.

## Setup Instructions

### Prerequisites

- A Linux server outside the restricted network (External Node).
- A local machine or server inside the restricted network (Internal Node).
- Go installed on both machines (if compiling from source).

### 1. Installation

You can install Elahe Tunnel by running the provided installation script:

```bash
chmod +x install.sh
./install.sh
```

This script will compile the application and set up the necessary binaries.

### 2. Setting up the External Node (Server)

1. Run the setup command on your external server:
   ```bash
   elahe-tunnel setup
   ```
2. Choose **External** when prompted for the node type.
3. The setup process will generate a **Connection Key**. Copy this key, as you will need it for the internal node.
4. Start the server in background:
   ```bash
   elahe-tunnel run
   ```
   The server will start in the background and listen on port 443.
5. To check status or stop:
   ```bash
   elahe-tunnel status
   elahe-tunnel stop
   ```

### 3. Setting up the Internal Node (Client)

1. Run the setup command on your local machine:
   ```bash
   elahe-tunnel setup
   ```
2. Choose **Internal** when prompted for the node type.
3. Enter the IP address or domain name of your External Node.
4. Paste the **Connection Key** generated by the External Node.
5. Configure additional options such as enabling the Web Panel, DNS Proxy, and UDP Proxy as desired.
6. Start the client in background:
   ```bash
   elahe-tunnel run
   ```
7. To check status or stop:
   ```bash
   elahe-tunnel status
   elahe-tunnel stop
   ```

### 4. Using the Tunnel

Once both nodes are running, the internal node will establish a secure connection to the external node.

- **TCP Proxy**: By default, the internal node listens on `localhost:9090` for TCP traffic. You can configure your applications to use this as a SOCKS5 proxy.
- **UDP Proxy**: If enabled, the UDP proxy listens on `localhost:9091`.
- **DNS Proxy**: If enabled, the DNS proxy listens on `localhost:53`. You can set your system's DNS server to `127.0.0.1` to route all queries through the tunnel.

### 5. Web Panel

If you enabled the Web Panel during the internal node setup, you can access it by opening a web browser and navigating to:

```
http://localhost:<Web_Panel_Port>
```

The web panel provides real-time statistics on:
- Connection Health
- Total Data Transferred
- TCP and UDP Traffic Rates
- DNS Queries and Error Rates

## Integration with X-UI / Xray / V2Ray

If you want to use Elahe Tunnel to protect your Xray/V2Ray traffic, follow this architecture to avoid port conflicts:

### 1. External Server (Outside)
- **X-UI/Xray**: Set your inbound port to something other than 443 (e.g., `8081`).
- **Elahe Tunnel**: Run as **External** on port **443**.

### 2. Internal Server (Iran)
- **Elahe Tunnel**: Run as **Internal**.
- **Remote Host**: Your External Server IP.
- **Tunnel Port**: `443`.
- **Destination Host**: `127.0.0.1:8081` (This points to the Xray port on the external server).
- **Local Port**: `443` (The port you will connect to from your phone/PC).

### 3. Client Connection
In your VPN app (v2rayNG, Shadowrocket, etc.), use the **Internal Server IP** and port **443**. Your traffic will now be:
`Client` -> `Iran Server:443` -> `(Encrypted Tunnel)` -> `External Server:443` -> `Xray:8081`

## Troubleshooting

### Connection Refused Error
If you see `connection refused` errors in the client logs, it means the external server is not accepting connections on port 443.

**Steps to fix:**

1.  **SSH into your External Server.**
2.  **Download and run the diagnostic tool:**
    ```bash
    curl -sL https://raw.githubusercontent.com/ehsanking/elahe-tunnel/main/troubleshoot.sh | bash
    ```
3.  **Manual Checks:**
    *   **Check if running:** `pgrep -a elahe-tunnel`
    *   **Check port 443:** `netstat -tulnp | grep 443`
    *   **Check Firewall:** `ufw status` (ensure 443/tcp is ALLOWED)
    *   **Check Cloud Firewall:** If using AWS/GCP/Azure, check Security Groups to allow Inbound TCP 443.

- **Invalid Key**: Verify that the connection key matches exactly between the internal and external nodes.
- **DNS Leaks**: Ensure your system is configured to use the local DNS proxy (`127.0.0.1`) and that no other DNS servers are overriding it.

## Security Considerations

While Elahe Tunnel provides strong encryption and masquerading, it is important to keep your connection key secure. Do not share it publicly. Additionally, the DTLS implementation uses self-signed certificates; ensure you trust the external node you are connecting to.
